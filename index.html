// Apps Script (Google Sheets backend)
const SS = SpreadsheetApp.getActiveSpreadsheet();

function doGet(e) {
  const action = e.parameter.action;
  if (action === "getGroups") {
    return getGroups();
  } else if (action === "getRequests") {
    return getRequests();
  } else {
    return ContentService.createTextOutput(JSON.stringify({error:"No action specified"})).setMimeType(ContentService.MimeType.JSON);
  }
}

function doPost(e) {
  // Expect JSON in body
  const payload = JSON.parse(e.postData.contents);
  if (payload.type === "group") {
    return saveGroup(payload);
  } else if (payload.type === "join") {
    return joinGroup(payload);
  } else {
    return ContentService.createTextOutput(JSON.stringify({status:"error", message:"invalid type"})).setMimeType(ContentService.MimeType.JSON);
  }
}

/** Save group to CarPoolGroups sheet */
function saveGroup(data) {
  const sheet = SS.getSheetByName("CarPoolGroups");
  if (!sheet) return ContentService.createTextOutput(JSON.stringify({status:"error", message:"CarPoolGroups sheet missing"})).setMimeType(ContentService.MimeType.JSON);
  // Append row: GroupName, Trigram, Phone, From, To, TotalSeats, RemainingSeats, ReturnType, Members
  const membersInit = data.ownerName; // owner is initial member
  sheet.appendRow([data.ownerName, data.trigram || "", data.phone || "", data.from || "", data.to || "", Number(data.totalSeats) || 0, Number(data.totalSeats) || 0, data.returnType || "", membersInit]);
  return ContentService.createTextOutput(JSON.stringify({status:"ok", message:"group saved"})).setMimeType(ContentService.MimeType.JSON);
}

/** Join group: append to JoinRequests and update CarPoolGroups if seats available */
function joinGroup(data) {
  const reqSheet = SS.getSheetByName("JoinRequests");
  const groupSheet = SS.getSheetByName("CarPoolGroups");
  if (!reqSheet || !groupSheet) return ContentService.createTextOutput(JSON.stringify({status:"error", message:"Required sheet(s) missing"})).setMimeType(ContentService.MimeType.JSON);

  // Append request record
  const ts = new Date();
  reqSheet.appendRow([ts, data.requestName, data.targetGroup, data.message || "", "Pending"]);

  // Find group row
  const range = groupSheet.getDataRange();
  const values = range.getValues(); // 2D array
  const headers = values[0];
  let foundRow = -1;
  for (let i = 1; i < values.length; i++) {
    if (String(values[i][0]).trim() === String(data.targetGroup).trim()) {
      foundRow = i + 1; // sheet rows are 1-indexed
      break;
    }
  }
  if (foundRow === -1) {
    return ContentService.createTextOutput(JSON.stringify({status:"error", message:"Group not found"})).setMimeType(ContentService.MimeType.JSON);
  }

  // columns positions (1-indexed):
  // 1: GroupName, 6: TotalSeats, 7: RemainingSeats, 9: Members
  const remainingCol = 7;
  const membersCol = 9;
  const remaining = Number(groupSheet.getRange(foundRow, remainingCol).getValue());
  if (remaining <= 0) {
    // update request status to Rejected (optional)
    const lastRow = reqSheet.getLastRow();
    reqSheet.getRange(lastRow, 5).setValue("Rejected - No seats");
    return ContentService.createTextOutput(JSON.stringify({status:"error", message:"No seats available"})).setMimeType(ContentService.MimeType.JSON);
  }

  // Auto-approve: add member to members list and decrement remaining seats
  const currentMembers = String(groupSheet.getRange(foundRow, membersCol).getValue());
  const updatedMembers = currentMembers ? currentMembers + ", " + data.requestName : data.requestName;
  groupSheet.getRange(foundRow, membersCol).setValue(updatedMembers);
  groupSheet.getRange(foundRow, remainingCol).setValue(remaining - 1);

  // Update join request status to Approved
  const lastRowId = reqSheet.getLastRow();
  reqSheet.getRange(lastRowId, 5).setValue("Approved");

  return ContentService.createTextOutput(JSON.stringify({status:"ok", message:"Joined and updated group"})).setMimeType(ContentService.MimeType.JSON);
}

/** Return groups as JSON (including header row) */
function getGroups() {
  const sheet = SS.getSheetByName("CarPoolGroups");
  if (!sheet) return ContentService.createTextOutput(JSON.stringify({status:"error", message:"CarPoolGroups missing"})).setMimeType(ContentService.MimeType.JSON);
  const values = sheet.getDataRange().getValues();
  return ContentService.createTextOutput(JSON.stringify(values)).setMimeType(ContentService.MimeType.JSON);
}

function getRequests() {
  const sheet = SS.getSheetByName("JoinRequests");
  if (!sheet) return ContentService.createTextOutput(JSON.stringify({status:"error", message:"JoinRequests missing"})).setMimeType(ContentService.MimeType.JSON);
  const values = sheet.getDataRange().getValues();
  return ContentService.createTextOutput(JSON.stringify(values)).setMimeType(ContentService.MimeType.JSON);
}
